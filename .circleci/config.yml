version: 2.1

jobs:
  s3-deploy:
    docker:
      - image: 'cimg/python:3.6'
    steps:
      - checkout
      - run:
          name: Install AWS CLI
          command: |
            python -m pip install --upgrade pip
            pip install awscli
      - run:
          name: Deploy to S3 (Development)
          command: |
            aws s3 sync ./ s3://curious-reader-books-development \
              --acl public-read \
              --cache-control "max-age=86400" \
              --region $AWS_DEFAULT_REGION
          environment:
            AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY
            AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY

  s3-deploy-prod:
    docker:
      - image: 'cimg/python:3.6'
    steps:
      - checkout
      - run:
          name: Install AWS CLI
          command: |
            python -m pip install --upgrade pip
            pip install awscli
      - run:
          name: Deploy to S3 (Production)
          command: |
            aws s3 sync ./ s3://curious-reader-books-production \
              --acl public-read \
              --cache-control "max-age=86400" \
              --region $AWS_PROD_REGION
          environment:
            AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY
            AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY

workflows:
  s3-deploy-workflow:
    jobs:
      - s3-deploy:
          filters:
            branches:
              only:
                - develop
      - s3-deploy-prod:
          filters:
            branches:
              only:
                - main

